name: Build Fonts and Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'sources/Plangothic-Regular.7z'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€æŸ¥ä»“åº“ / Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: å®‰è£…ä¾èµ–é¡¹ / Install dependencies
        run: |
          mkdir -p ~/.cache/pip

          sudo apt-get update -q
          sudo apt-get install --no-install-recommends -y \
            p7zip-full \
            python3-pip \
            ttfautohint \
            parallel \
            fuse
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

          wget -qO FontForge.AppImage \
            https://github.com/fontforge/fontforge/releases/download/20251009/FontForge-2025-10-09-Linux-x86_64.AppImage
          chmod +x FontForge.AppImage

          ./FontForge.AppImage --appimage-extract
          sudo mv squashfs-root /opt/fontforge

          sudo tee /usr/local/bin/fontforge << 'EOF'
          #!/usr/bin/env bash
          export APPDIR=/opt/fontforge
          export PATH="$APPDIR/usr/bin:$PATH"
          export LD_LIBRARY_PATH="$APPDIR/usr/lib:$LD_LIBRARY_PATH"
          export PYTHONPATH="$APPDIR/usr/lib/python3/dist-packages:$PYTHONPATH"
          exec "$APPDIR/usr/bin/fontforge" "$@"
          EOF
          sudo chmod +x /usr/local/bin/fontforge

          pip install --no-cache-dir --upgrade pip
          pip install --no-cache-dir fonttools brotli fontmake

      - name: æå–æ–‡ä»¶ / Extract files
        run: |
          mkdir -p temp
          7z x sources/Plangothic-Regular.7z -obuild/

      - name: ä¼˜åŒ–å¹¶è½¬æ¢å­—ä½“ / Optimize and Convert Fonts
        run: |
          mkdir -p optimized fonts/otf fonts/web fonts/static

          echo "===== å¼€å§‹ä¼˜åŒ–å­—å½¢ ====="
          find build -name "Plangothic*-Regular.ttf" | parallel fontforge -script tools/optimize_glyph.py {} -s 0.5
          mv build/*_merge_glyphs.ttf optimized/

          process_fonts() {
            local format=$1
            local target_dir=$2
            local extension=$3

            echo "===== å¼€å§‹è½¬æ¢ä¸º${format}æ ¼å¼ ====="
            find optimized -name "Plangothic*-Regular_merge_glyphs.ttf" | parallel "fontforge -script tools/convert_font.py {} -f ${format}"

            for ttf in optimized/Plangothic*-Regular_merge_glyphs.ttf; do
              base=$(basename "$ttf" _merge_glyphs.ttf)
              found=false

              for location in "./" "optimized/"; do
                source_file="${location}${base}_merge_glyphs.${extension}"
                if [ -f "$source_file" ]; then
                  echo "æ‰¾åˆ°${format}æ–‡ä»¶: $source_file"
                  mv "$source_file" "${target_dir}/${base}.${extension}"
                  found=true
                  break
                fi
              done

              if [ "$found" = false ]; then
                echo "è­¦å‘Š: æœªèƒ½åœ¨é¢„æœŸä½ç½®æ‰¾åˆ°${base}çš„${format}æ–‡ä»¶"
                echo "å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„æ–‡ä»¶:"
                find . -name "*${base}*.${extension}" -o -name "*Plangothic*.${extension}"
              fi
            done
          }

          process_fonts "otf" "fonts/otf" "otf"
          process_fonts "woff2" "fonts/web" "woff2"

          echo "===== åˆ›å»ºé™æ€TTFæ–‡ä»¶ ====="
          for ttf in optimized/*_merge_glyphs.ttf; do
            base=$(basename "$ttf" _merge_glyphs.ttf)
            cp "$ttf" "fonts/static/${base}.ttf"
          done

          echo "===== ç”Ÿæˆæ–‡ä»¶éªŒè¯ ====="
          echo "OTFæ–‡ä»¶:"
          ls -la fonts/otf/
          echo "WOFF2æ–‡ä»¶:"
          ls -la fonts/web/
          echo "TTFæ–‡ä»¶:"
          ls -la fonts/static/

      - name: åˆå¹¶å­—ä½“åˆ°é›†åˆ / Merge Fonts to Collections
        run: |
          python3 - <<EOF
          from fontTools.ttLib import TTFont
          from fontTools.ttLib.ttCollection import TTCollection

          def merge_fonts(input_files, output_file):
              collection = TTCollection()
              for font_file in input_files:
                  font = TTFont(font_file)
                  collection.fonts.append(font)
              collection.save(output_file)
              print(f"å·²åˆ›å»ºå­—ä½“é›†åˆæ–‡ä»¶: {output_file}")

          import os
          os.makedirs("fonts/static", exist_ok=True)
          os.makedirs("fonts/otf", exist_ok=True)

          ttf_files = ["fonts/static/PlangothicP1-Regular.ttf", "fonts/static/PlangothicP2-Regular.ttf"]
          merge_fonts(ttf_files, "fonts/static/Plangothic.ttc")

          otf_files = ["fonts/otf/PlangothicP1-Regular.otf", "fonts/otf/PlangothicP2-Regular.otf"]
          merge_fonts(otf_files, "fonts/otf/Plangothic.ttc")
          EOF

      - name: ç”Ÿæˆæ„å»ºä¿¡æ¯ / Generate Build Info
        run: |
          mkdir -p build-info

          cat > build-info/build-info.json << EOF
          {
            "build_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "commit_sha": "$GITHUB_SHA",
            "commit_message": "$(git log -1 --pretty=%B | tr '\n' ' ' | sed 's/"/\\"/g')",
            "branch": "${GITHUB_REF#refs/heads/}",
            "workflow_run": "$GITHUB_RUN_NUMBER",
            "actor": "$GITHUB_ACTOR"
          }
          EOF

          echo "# æ„å»ºäº§ç‰©æ¸…å•" > build-info/manifest.md
          echo "" >> build-info/manifest.md
          echo "## æ–‡ä»¶åˆ—è¡¨" >> build-info/manifest.md
          echo "" >> build-info/manifest.md
          find fonts -type f | sort | while read file; do
            size=$(du -h "$file" | cut -f1)
            echo "- \`$file\` ($size)" >> build-info/manifest.md
          done

      - name: éƒ¨ç½²åˆ°buildåˆ†æ”¯ / Deploy to build branch
        run: |
          cp -r fonts /tmp/fonts
          cp -r build-info /tmp/build-info
          rm -rf fonts build-info build/

          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          if git show-ref --verify --quiet refs/remotes/origin/build; then
            git checkout build
            git pull origin build
          else
            git checkout --orphan build
            git rm -rf .
          fi

          find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +

          cp -r /tmp/fonts fonts
          cp -r /tmp/build-info build-info

          git add .
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "deploy: ${GITHUB_SHA:0:7}"

            git push origin build
            printf "\e]8;;https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}\adeploy: %s\e]8;;\a\n" "${GITHUB_SHA:0:7}"
          fi

      - name: ä¸Šä¼ æ„å»ºäº§ç‰© / Upload artifacts  
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: font-files-${{ github.run_number }}
          path: |
            fonts/
            build-info/
          retention-days: 30

      - name: åˆ›å»ºå‘å¸ƒæ‘˜è¦ / Create Release Summary
        if: success()
        run: |
          echo "## ğŸ‰ å­—ä½“æ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š æ„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤SHA**: \`$GITHUB_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "- **å·¥ä½œæµè¿è¡Œ**: #$GITHUB_RUN_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          find fonts -type f | sort >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ”— è®¿é—®é“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [buildåˆ†æ”¯](../../tree/build)" >> $GITHUB_STEP_SUMMARY
          echo "- [å­—ä½“æ–‡ä»¶](../../tree/build/fonts)" >> $GITHUB_STEP_SUMMARY
          echo "- [æ„å»ºä¿¡æ¯](../../tree/build/build-info)" >> $GITHUB_STEP_SUMMARY

      - name: å¤±è´¥æ—¶è°ƒè¯• / Debug on failure
        if: failure()
        run: |
          echo "===== è°ƒè¯•ä¿¡æ¯ ====="
          echo "ç›®å½•ç»“æ„:"
          find . -type f -name "*.ttf" -o -name "*.otf" -o -name "*.woff2" | sort

          echo "ç£ç›˜ç©ºé—´:"
          df -h

          echo "GitçŠ¶æ€:"
          git status

          echo "æœ€è¿‘çš„æ—¥å¿—:"
          tail -n 100 $(find /tmp -name "*.log" -type f 2>/dev/null | head -1) 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°æ—¥å¿—æ–‡ä»¶"

          echo "ç¯å¢ƒå˜é‡:"
          env | grep -v -E "TOKEN|SECRET|KEY" | sort